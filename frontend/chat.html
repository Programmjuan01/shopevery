<!DOCTYPE html><html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat · Shopevery</title>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">

  <style>
    .bubble-me    { background:#d1e7dd; align-self:flex-end; }
    .bubble-other { background:#e9ecef; align-self:flex-start; }
    .bubble       { max-width:75%; border-radius:.75rem; padding:.5rem .75rem; word-break:break-word; }
    .author       { font-weight:600; margin-right:.25rem; }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="/">Shopevery</a>
      <span id="chatWith" class="fw-semibold"></span>
    </div>
  </nav>

  <main class="container py-3 d-flex flex-column" style="height:85vh">
    <div id="chatBox"
         class="flex-grow-1 d-flex flex-column gap-2 mb-3 overflow-auto border rounded p-3 bg-white">
      <!-- mensajes -->
    </div>

    <form id="sendForm" class="d-flex gap-2">
      <input id="msgBody" class="form-control" placeholder="Escribe un mensaje…">
      <button class="btn btn-primary d-flex align-items-center gap-1 px-3">
        <i class="bi bi-send-fill"></i>
        <span class="d-none d-sm-inline">Enviar</span>
      </button>
    </form>
  </main>

  <script type="module">
  import { getToken, isLogged, getUid, getName } from './auth.js';

  if (!isLogged()) location.href = '/';

  const API     = '/api';
  const meId    = getUid();
  const meName  = getName();
  const other   = new URL(location).searchParams.get('uid');
  if (!other) location.href = '/';

  const chatBox  = document.getElementById('chatBox');
  const chatWith = document.getElementById('chatWith');
  const msgInput = document.getElementById('msgBody');
  const sendForm = document.getElementById('sendForm');
  const headers  = { Authorization: 'Bearer ' + getToken() };

  const nameCache = { [meId]: meName };
  let lastTimestamp = null;

  async function getUserName(uid) {
    if (nameCache[uid]) return nameCache[uid];
    const res = await fetch(`${API}/users/search?q=`, { headers });
    const users = await res.json();
    for (const u of users) {
      nameCache[u._id] = u.name;
    }
    return nameCache[uid] || 'Desconocido';
  }

  async function fetchNames() {
    const res = await fetch(`${API}/users/search?q=`, { headers });
    const list = await res.json();
    const otherUser = list.find(u => u._id === other);
    if (otherUser) {
      nameCache[other] = otherUser.name;
      chatWith.textContent = 'Chateando con ' + otherUser.name;
    } else {
      nameCache[other] = 'Usuario';
      chatWith.textContent = 'Chateando con Usuario';
    }
  }

  function bubbleHTML(msg, author) {
    const mine = msg.from === meId;
    return `
      <div class="bubble ${mine ? 'bubble-me ms-auto' : 'bubble-other'}">
        <span class="author">${author}:</span>${msg.body}
      </div>`;
  }

  async function loadChat() {
    const res = await fetch(`${API}/messages/${other}`, { headers });
    const arr = await res.json();

    for (const m of arr) {
      if (lastTimestamp && new Date(m.ts) <= new Date(lastTimestamp)) continue;
      const author = await getUserName(m.from);
      chatBox.insertAdjacentHTML('beforeend', bubbleHTML(m, author));
      lastTimestamp = m.ts;
    }

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  sendForm.addEventListener('submit', async e => {
    e.preventDefault();
    const body = msgInput.value.trim();
    if (!body) return;

    const now = new Date().toISOString();
    chatBox.insertAdjacentHTML('beforeend', bubbleHTML({ from: meId, body, ts: now }, meName));
    lastTimestamp = now;
    chatBox.scrollTop = chatBox.scrollHeight;

    await fetch(API + '/messages', {
      method: 'POST',
      headers: { ...headers, 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: other, body })
    });

    msgInput.value = '';
  });

  await fetchNames();
  await loadChat();

  // Refresca el chat cada 3 segundos (ajustable)
  setInterval(loadChat, 3000);
  </script>



  <!-- Bootstrap icons (solo para el icono de enviar) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.js"></script>
</body></html>
